<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>YOLO People Counter — Cerca Virtual</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap: 12px; }
    body{font-family: system-ui, Arial, sans-serif; margin:24px;}
    .card{border:1px solid #ddd; border-radius:10px; padding:16px; margin-bottom:16px;}
    label{display:block; margin:8px 0 4px;}
    input[type="number"], input[type="file"], select{width:100%; padding:8px;}
    .row{display:flex; gap:var(--gap); flex-wrap:wrap;}
    .row > div{flex:1; min-width:220px;}
    button{padding:10px 16px; border:0; border-radius:6px; background:#111; color:#fff; cursor:pointer;}
    button.secondary{background:#f1f1f1; color:#111; border:1px solid #ddd;}
    pre{background:#f7f7f7; padding:12px; overflow:auto; max-height:420px;}
    .small{color:#666; font-size:12px;}
    .pill{display:inline-block; padding:4px 8px; background:#eee; border-radius:999px; margin-right:8px;}
    .canvas-wrap{position:relative; display:inline-block; max-width:100%;}
    canvas{max-width:100%; border:1px dashed #bbb; border-radius:6px;}
    .legend{display:flex; gap:8px; align-items:center; margin-top:8px;}
    .dot{width:12px; height:12px; border-radius:50%;}
    .dot.a{background:#0d6efd;}
    .dot.b{background:#dc3545;}
    .coords{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .hidden{display:none;}
  </style>
</head>
<body>
  <h1>Contagem de Pessoas — YOLO + Cerca Virtual</h1>

  <div class="card">
    <form id="uploadForm">
      <div class="row">
        <div>
          <label>Vídeo (mp4, mov, mkv...)</label>
          <input id="videoInput" type="file" name="video" accept="video/*" required />
          <div class="small">Ao selecionar o vídeo, capturamos o primeiro frame para desenhar a cerca.</div>
        </div>
        <div>
          <label>FPS de amostragem</label>
          <input type="number" name="sample_fps" step="0.5" min="0.5" max="30" value="5"/>
          <div class="small">Maior = mais precisão, porém mais lento</div>
        </div>
        <div>
          <label>Duração do chunk (segundos)</label>
          <input type="number" name="chunk_seconds" step="10" min="10" max="600" value="60"/>
          <div class="small">Vídeo é fatiado em blocos de 1 min (ou o valor escolhido)</div>
        </div>
        <div>
          <label>Trabalhadores paralelos</label>
          <input type="number" name="workers" step="1" min="0" max="8" value="0"/>
          <div class="small">0 = auto (usa CPU disponível)</div>
        </div>

        <div>
          <label>Exportar vídeo anotado?</label>
          <select name="save_annotated">
            <option value="1" selected>Sim</option>
            <option value="0">Não</option>
          </select>
        </div>
      </div>

      <!-- Canvas para desenhar a cerca -->
      <div style="margin-top:16px;">
        <div class="row">
          <div style="flex:2; min-width:320px;">
            <div class="canvas-wrap">
              <canvas id="drawCanvas" width="960" height="540"></canvas>
            </div>
            <div class="legend">
              <div class="dot a"></div><span class="small">Ponto A (início da linha)</span>
              <div class="dot b"></div><span class="small">Ponto B (fim da linha)</span>
            </div>
            <div class="small" style="margin-top:6px;">
              Clique e arraste para desenhar a cerca. Dica: o sentido A→B define a direção do <b>IN</b> (negativo→positivo).
            </div>
          </div>
          <div style="flex:1; min-width:260px;">
            <label>Coordenadas normalizadas (0..1)</label>
            <div class="coords" id="coordPreview">x1=— y1=— | x2=— y2=—</div>
            <div style="margin-top:8px; display:flex; gap:var(--gap);">
              <button type="button" id="btnReset" class="secondary">Limpar linha</button>
              <button type="button" id="btnFlip" class="secondary">Inverter direção (A↔B)</button>
            </div>
            <div class="small" style="margin-top:8px;">
              Se preferir, você pode ignorar o canvas e usar os campos ocultos preenchidos automaticamente.
            </div>
          </div>
        </div>
      </div>

      <!-- Inputs ocultos que serão enviados -->
      <input type="hidden" name="x1" id="x1" />
      <input type="hidden" name="y1" id="y1" />
      <input type="hidden" name="x2" id="x2" />
      <input type="hidden" name="y2" id="y2" />

      <br/>
      <button type="submit">Processar</button>
    </form>
  </div>

  <div class="card">
    <h3>Resultado</h3>
    <div id="status" class="small">aguardando upload…</div>
    <div id="summary"></div>
    <pre id="json"></pre>
  </div>

  <!-- Vídeo oculto só para capturar o frame -->
  <video id="hiddenVideo" class="hidden" playsinline muted></video>

  <script src="/static/app.js"></script>
</body>
</html>
